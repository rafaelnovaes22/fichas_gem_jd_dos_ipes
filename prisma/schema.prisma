// Sistema GEM - Gestão de Ensino Musical
// Schema do banco de dados

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum Role {
  ADMIN
  INSTRUTOR
  ENCARREGADO
}

enum TipoAula {
  SOLFEJO
  TEORIA_MUSICAL
  PRATICA_INSTRUMENTO
  HINARIO
}

enum Justificativa {
  ENFERMIDADE
  TRABALHO
  VIAGEM
  OUTROS
}

enum FaseOrquestra {
  ESTUDANDO
  ENSAIO_LOCAL
  ENSAIO
  RJM
  CULTO
  TROCA_INSTRUMENTO_CULTO
  TROCA_INSTRUMENTO_OFICIALIZACAO
  OFICIALIZACAO
  OFICIALIZADO
}

enum DiaSemana {
  DOMINGO
  SEGUNDA
  TERCA
  QUARTA
  QUINTA
  SEXTA
  SABADO
}

enum NivelProgramaMinimo {
  RJM
  CULTO
  OFICIALIZACAO
}

enum TipoConteudoPM {
  METODO_INSTRUMENTO
  TEORIA
  SOLFEJO
  HINARIO
}

// ==========================================
// MODELOS
// ==========================================

model Usuario {
  id        String   @id @default(cuid())
  email     String   @unique
  senha     String
  nome      String
  telefone  String?
  role      Role     @default(INSTRUTOR)
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  instrutor Instrutor?

  @@map("usuarios")
}

model Instrutor {
  id           String   @id @default(cuid())
  usuarioId    String   @unique
  usuario      Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  congregacao  String
  instrumentos String[] // Instrumentos que leciona

  alunosPrincipais  Aluno[] @relation("InstrutorPrincipal")
  alunosSecundarios Aluno[] @relation("InstrutorSecundario")
  aulas             AulaRegistro[]
  avaliacoes        Avaliacao[]
  turmas            Turma[]
  sessoes           SessaoAula[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("instrutores")
}

model Instrumento {
  id        String  @id @default(cuid())
  nome      String  @unique
  categoria String // Cordas, Sopro, Teclas, Percussão, etc.
  ativo     Boolean @default(true)

  alunos Aluno[]
  programasMinimo ProgramaMinimo[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("instrumentos")
}

model Fase {
  id        String  @id @default(cuid())
  nome      String  @unique
  descricao String?
  ordem     Int
  ativo     Boolean @default(true)

  alunos Aluno[]
  topicos TopicoMSA[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("fases")
}

model TopicoMSA {
  id        String @id @default(cuid())
  faseId    String
  fase      Fase   @relation(fields: [faseId], references: [id])
  
  numero    String // Ex: "1.1", "2.3"
  titulo    String // Ex: "Música e som"
  descricao String?

  aulas     AulaRegistro[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("topicos_msa")
}

model Aluno {
  id              String    @id @default(cuid())
  nome            String
  dataNascimento  DateTime?
  telefone        String?
  email           String?
  congregacao     String

  // Instrutor principal (obrigatório)
  instrutorId String
  instrutor   Instrutor @relation("InstrutorPrincipal", fields: [instrutorId], references: [id])

  // Segundo instrutor (opcional)
  instrutor2Id String?
  instrutor2   Instrutor? @relation("InstrutorSecundario", fields: [instrutor2Id], references: [id], onDelete: SetNull)

  instrumentoId String
  instrumento   Instrumento @relation(fields: [instrumentoId], references: [id])

  faseId String
  fase   Fase   @relation(fields: [faseId], references: [id])

  faseOrquestra FaseOrquestra @default(ESTUDANDO)

  autorizacaoDados Boolean @default(false)
  ativo            Boolean @default(true)

  fichas FichaAcompanhamento[]
  turmas TurmaAluno[]
  sessoesRegistros SessaoAulaRegistro[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("alunos")
}

model FichaAcompanhamento {
  id      String @id @default(cuid())
  alunoId String
  aluno   Aluno  @relation(fields: [alunoId], references: [id], onDelete: Cascade)

  tipoAula TipoAula

  aulas      AulaRegistro[]
  avaliacoes Avaliacao[]

  mediaFinal      Float?
  resultadoFinal  String?
  apto            Boolean?

  encarregadoLocal String?

  dataFinalizacao  DateTime?

  nivel String?
  livro String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("fichas_acompanhamento")
}

model AulaRegistro {
  id      String              @id @default(cuid())
  fichaId String
  ficha   FichaAcompanhamento @relation(fields: [fichaId], references: [id], onDelete: Cascade)

  numeroAula    Int // 1-20
  
  topicoMsaId   String?
  topicoMsa     TopicoMSA? @relation(fields: [topicoMsaId], references: [id], onDelete: SetNull)

  data          DateTime
  anotacoes     String?
  
  presenca      Boolean        @default(false)
  ausencia      Boolean        @default(false)
  justificativa Justificativa?

  instrutorId    String
  instrutor      Instrutor @relation(fields: [instrutorId], references: [id], onDelete: Restrict)
  vistoInstrutor Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fichaId, numeroAula])
  @@map("aulas_registro")
}

model Avaliacao {
  id      String              @id @default(cuid())
  fichaId String
  ficha   FichaAcompanhamento @relation(fields: [fichaId], references: [id], onDelete: Cascade)

  numeroAvaliacao Int // 1-3
  data            DateTime
  nota            Float?
  anotacoes       String?

  presenca      Boolean        @default(false)
  ausencia      Boolean        @default(false)
  justificativa Justificativa?

  instrutorId    String
  instrutor      Instrutor @relation(fields: [instrutorId], references: [id], onDelete: Restrict)
  vistoInstrutor Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fichaId, numeroAvaliacao])
  @@map("avaliacoes")
}

// ==========================================
// TURMAS E SESSÕES DE AULA
// ==========================================

model Turma {
  id           String      @id @default(cuid())
  nome         String
  descricao    String?
  instrutorId  String
  instrutor    Instrutor   @relation(fields: [instrutorId], references: [id])
  diaSemana    DiaSemana?
  horario      String?
  ativo        Boolean     @default(true)
  alunos       TurmaAluno[]
  sessoes      SessaoAula[]
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@map("turmas")
}

model TurmaAluno {
  id        String   @id @default(cuid())
  turmaId   String
  turma     Turma    @relation(fields: [turmaId], references: [id], onDelete: Cascade)
  alunoId   String
  aluno     Aluno    @relation(fields: [alunoId], references: [id], onDelete: Cascade)
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())

  @@unique([turmaId, alunoId])
  @@map("turma_alunos")
}

model SessaoAula {
  id          String   @id @default(cuid())
  turmaId     String
  turma       Turma    @relation(fields: [turmaId], references: [id], onDelete: Cascade)
  data        DateTime
  descricao   String?
  instrutorId String
  instrutor   Instrutor @relation(fields: [instrutorId], references: [id])
  registros   SessaoAulaRegistro[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("sessoes_aula")
}

model SessaoAulaRegistro {
  id            String      @id @default(cuid())
  sessaoId      String
  sessao        SessaoAula  @relation(fields: [sessaoId], references: [id], onDelete: Cascade)
  alunoId       String
  aluno         Aluno       @relation(fields: [alunoId], references: [id])
  presenca      Boolean     @default(false)
  ausencia      Boolean     @default(false)
  justificativa Justificativa?
  anotacoes     String?
  conteudoAtribuido String?
  sincronizadoFicha Boolean @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([sessaoId, alunoId])
  @@map("sessao_aula_registros")
}

// ==========================================
// PROGRAMA MÍNIMO PARA MÚSICOS
// ==========================================

model ProgramaMinimo {
  id            String   @id @default(cuid())
  instrumentoId String
  instrumento   Instrumento @relation(fields: [instrumentoId], references: [id])
  nivel         NivelProgramaMinimo
  itens         ProgramaMinimoItem[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([instrumentoId, nivel])
  @@map("programa_minimo")
}

model ProgramaMinimoItem {
  id               String   @id @default(cuid())
  programaMinimoId String
  programaMinimo   ProgramaMinimo @relation(fields: [programaMinimoId], references: [id], onDelete: Cascade)
  tipo             TipoConteudoPM
  descricao        String
  alternativas     String?
  obrigatorio      Boolean  @default(true)
  ordem            Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("programa_minimo_itens")
}
